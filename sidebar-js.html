<script>
  let tempSettings = {}
  let refCodes = []

  $(function () {
    google.script.run.withSuccessHandler(initialiseSidebar).getSettings()
  })

  function htmlEncode(str) {
    return String(str).replace(/[^\w. ]/gi, function (c) {
      return '&#' + c.charCodeAt(0) + ''
    })
  }

  const isDefault = (labCode) => ['equat', 'figur', 'table', 'fnote'].includes(labCode)

  //
  // # Update the sidebar
  //


  function initialiseSidebar(settings) {

    tempSettings = { ...settings }

    const byName = Object.entries(settings).sort((a, b) => a[1].name - b[1].name)

    byName.forEach((entry) => {
      const data = entry[1]
      refCodes.push(data.ref.code)
      $('#category-select').append($('<option>', {
        text: data.name,
        value: data.lab.code,
        data: data.lab.code,
      }))
    })

    const firstLabCode = byName[0][1].lab.code

    $('#category-select').data('val', firstLabCode)
    updateSidebar(firstLabCode)

    $('#delete-category').css('display', isDefault(firstLabCode) ? 'none' : 'block')
  }

  function updateColor(id, color) {
    color = color || '#000'
    const $id = $(id)

    $id.find('.preview__text')
      .css('color', color)
    $id.find('.color-code')
      .val(color) // TODO: make it work with #
      .data('val', color) // TODO: make work with #
    $id.find('.color-icon')
      .css({ 'color': color, 'border-bottom-color': css })
  }

  function updateSidebar(labCode) {
    const setting = tempSettings[labCode]

    $('#lab_code').html('#' + setting.lab.code)
    $('#lab_text').val(setting.lab.text)
    $('#ref_code').val(setting.ref.code).html('#' + setting.ref.code)
    $('#ref_text').val(setting.ref.text)

    $('#lab').find('.preview__text').html(setting.lab.text + '1')
    $('#ref').find('.preview__text').html(setting.ref.text + '1')

    updateColor('#lab', setting.lab.color)
    updateColor('#ref', setting.ref.color)
    updateStyle(setting)
  }


  function updateStyle(setting) {
    const getValue = (styleProp, value = true) => {
      const css = {
        isBold: ['font-weight', 'bold'],
        isItalic: ['font-style', 'italic'],
        isUnderlined: ['text-decoration', 'underline'],
      }[styleProp]

      return [css[0], value ? css[1] : 'initial']
    }

    for (const typeCode in setting) {
      const subSetting = setting[typeCode]
      for (const key in subSetting) {
        const value = subSetting[key]
        const css = getValue(key, value) // TODO: naming

        $('#' + code).find('.preview__text')
          .css(...css)

        value
          ? $('#' + css[1]).addClass('style-button--selected')
          : $('#' + css[1]).removeClass('style-button--selected')
      }
    }
  }


  function selectCategory(labCode) {
    updateTempSettings()
    updateSidebar(labCode)

    $('#delete-category').css('display', isDefault(labCode) ? 'none' : 'block')
    $('#lab-cover').css('display', labCode === 'fnote' ? 'block' : 'none')
  }


  function updateTempSettings() {
    const idIsSelected = (id) => $(id).hasClass('style-button--selected') ? 'true' : 'null'
    const getColorValue = (id) => $(id).data('val') != undefined ? $(id).data('val') : null

    const labCode = $('#lab_code').html().substr(1)
    const colorCodes = $('.details').find('.color-code')

    tempSettings[labCode] = {
      name: $('#category-select').data('val'),
      lab: {
        code: labCode,
        text: $('#lab_text').val(),
        isBold: idIsSelected('#lab_bold'),
        isItalic: idIsSelected('#lab_italic'),
        isUnderlined: idIsSelected('#lab_underline'),
        color: getColorValue(colorCodes[0]),
      },
      ref: {
        code: labCode.substr(0, 3),
        text: $('#ref_text').val(),
        isBold: idIsSelected('#ref_bold'),
        isItalic: idIsSelected('#ref_italic'),
        isUnderlined: idIsSelected('#ref_underline'),
        color: getColorValue(colorCodes[1]),
      }
    }

    // data property records the previous category
    $('#category-select').data('val', $('#category-select').val())
  }



  // TODO: why?
  $('#category-select').on('focusin', function () {
    $(this).data('val', $(this).val())
  })


  $('#category-select').on('change', function () {
    selectCategory(this.value)
  })


  // TODO: name this function: what are we doing when we add category?
  $('#add-category').on('click', function () {

    const toHide = '.category__button, #category-select, #lab_code, .actions__row:not(:last-child)'
    const toShow = '#custom-category-name, #cs_lab_code, .actions__row:last-child'
    const toClear = '#custom-category-name, #lab_code, #lab_code_entry, #lab_text, #ref_code, #ref_text'

    $(toHide).css('display', 'none')
    $(toShow).css('display', 'block')
    $(toClear).val('')
    $('#ref_code').html('#')
    $('.preview__text').css({
      'color': 'unset',
      'font-weight': 'unset',
      'font-style': 'unset',
      'text-decoration': 'unset'
    }).html('&ltelement&gt')

    $('.color-button, .color-button *').css({ 'color': 'unset', 'border-bottom-color': 'unset' })
    $('.color-code').val(null).data('val', null)

    $('.style-button--selected').removeClass('style-button--selected')
  })


  $('#delete-category').on('click', function () {
    const ref = $('#ref_code').html().substr(1)
    const currentName = tempSettings[$('#category-select').val()].name

    $(this).css('display', 'none')
    google.script.run.withSuccessHandler(revertToFirstCategory).removePair(ref)
    $('#category-select option:contains("' + currentName + '")').remove()

    if (refCodes.includes(ref)) {
      refCodes.splice(refCodes.indexOf(ref), 1)
    }
  })


  //
  // # Custom screen
  //

  const getCurrentLabCode = () => ('#lab_code_entry').val()

  function revertCustomScreen() {

    const toHide = '#custom-category-name, #cs_lab_code, .actions__row:last-child'
    const toShow = '#category-select, #lab_code, .actions__row:not(:last-child)'

    $(toHide).css('display', 'none')
    $(toShow).css('display', 'block')
    $('#add-category').css('display', 'block')
    $('#set_defaults').prop('disabled', false)
  }


  function revertToFirstCategory() {
    const firstCode = $('#category-select option:first').val()

    $('#delete-category').css('display', (isDefault(firstCode)) ? 'block' : 'none')
    $('#category-select').val(firstCode)

    updateSidebar(firstCode)
  }



  $('#lab_code_entry').keyup(function () {
    const labCode = getCurrentLabCode()
    const refCode = labCode.substr(0, 3)

    $(this).val(labCode.toLowerCase())

    if (refCodes.includes(refCode)) {
      $('#taken').html('âš  in use')
        .css('color', '#9c3030')
      $(this).attr('maxlength', '3')
    } else {
      $(this).attr('maxlength', '5')
      $('#taken').html('5 letters min')
        .css('color', 'gray')
    }

    $('#lab_code').html('#' + labCode)
    $('#ref_code').html('#' + refCode)
  })


  $('#custom-category-name').keyup(function () {
    $('#category-select').data('val', this.value)
  })


  //TODO: won't work at the moment due to name stuff
  $('#save-custom').on('click', function () {
    const customName = $('#custom-category-name').val()
    let customSettings

    $('#save-apply').prop('disabled', true)
    saveProperties('#save-apply')

    customSettings = tempSettings[customName]

    google.script.run.storeCustom(customSettings)

    $('#category-select option:last').after($('<option>', { text: customName }))
    $('#category-select').val(customName)
    revertCustomScreen()
    $('#delete-category').css('display', 'block')
  })


  $('#cancel-custom').on('click', function () {
    revertToFirstCategory()
    revertCustomScreen()
  })


  // Disable saving a custom pairing while nameless or label code too short
  // TODO: more name debt
  document.onkeyup = function (e) {
    const name_length = $('#custom-category-name').val().length,
      lab_length = $('#lab_code_entry').val().length

    const disabled = (name_length > 0 && lab_length === 5) ? false : true

    $('#save-custom').prop('disabled', disabled)
  }


  //
  // # Settings panes
  //

  //
  // ## Text content
  //


  $('#lab_text').keyup(function () {
    const val = htmlEncode($(this).val())
    $('#lab').find('.preview__text').html(val + '1')
  })


  $('#ref_text').keyup(function () {
    const val = htmlEncode($(this).val())
    $('#ref').find('.preview__text').html(val + '1')
  })


  //
  // ## Text style
  //


  $('.style-button').on('click', function () {
    $(this).toggleClass('style-button--selected')

    const id = this.id
    const cssValueName = id.substr(4, this.length),
    const category = '#' + id.substr(0, 3)

    const cssProps = {
      'bold': 'font-weight',
      'italic': 'font-style',
      'underline': 'text-decoration'
    }

    const cssValue = ($(this).hasClass('style-button--selected')) ? cssValueName : 'initial'

    $(category).find('.preview__text').css(cssProps[cssValueName], cssValue)
  })


  //
  // ## Color
  //

  const isValidColor = (str) => (/([A-z0-9]{3}|[A-z0-9]{6})/g).test()

  function coerceToValidColor(colorValue) {
    if (!colorValue || !isValidColor(colorValue)) return null

    return colorValue.length === 3
      ? colorValue
        .split('')
        .reduce((tot, cur) => tot + cur.repeat(2), '')
      : colorValue
  }


  function confirmColor(button) {
    const $colorPane = button.parent()
    const $colorText = $colorPane.prev().children('div')
    const $colorCode = $colorPane.children('.color-code')
    const colorValue = coerceToValidColor($colorCode.val())

    let hex;
    if (colorValue) {
      hex = "#" + colorValue
      $colorCode.data('val', colorValue)
        .val(colorValue)
    } else {
      hex = "#000000"
      $colorCode.data('val', null)
        .val(colorValue)
    }

    $colorText.css({ 'color': hex, 'border-bottom-color': hex })
    $($colorPane.parentsUntil('.details').find('.preview__text')).css('color', hex)
    $colorPane.next().andSelf().hide()
  }


  const updateColorCode = type => hex => {
    if (typeof gsArray == 'undefined') return
    const id = '#' + type
    const hexNumber = hex.slice(1)
    $(id).find('.color-code').val(hexNumber)
  }


  function cancelColor(button) {
    const $code = button.siblings('.color-code').andSelf()
    $code.val($code.data('val'))
    button.parent().next().andSelf().hide()
  }



  $('.color-button').on('click', function () {
    $(this).nextAll('.color-hide').slice(0, 2).toggle()
    event.stopPropagation()
  })


  $('.color-code').on('keydown', function (e) {
    if (e.keyCode == 13) {
      confirmColor($(this))
    }
    if (e.keyCode == 27) {
      cancelColor($(this))
    }
  })


  $('.clone-color').on('click', function () {
    const type = $(this).closest('.main-section').attr('id')
    google.script.run.withSuccessHandler(updateColorCode(type)).cloneColor(type)
  })


  $('.confirm-color').on('click', function () {
    confirmColor($(this))
  })


  $('.cancel-color').on('click', function () {
    cancelColor($(this))
    event.stopPropagation()
  })


  // Hide color pane when anything else clicked
  $(document).on("click", function (e) {
    if ($(e.target).is('.color-pane, .color-pane *, .color-button')) return
    $('.color-hide').hide()
  })

  //
  // ## Main buttons
  //


  // Save the current sidebar settings as document settings
  function saveProperties(button) {
    updateTempSettings()
    google.script.run.withSuccessHandler(enableButton).updateProps(tempSettings)
  }


  function enableButton(button) {
    $(button).prop('disabled', false)
  }



  $('#save-defaults').on('click', function () {
    $(this).prop('disabled', true)
    updateTempSettings()
    google.script.run.withSuccessHandler(enableButton).storeDefault(tempSettings)
  })


  $('#restore-defaults').on('click', function () {
    $('#category-select').find('option').remove().end()
    google.script.run.withSuccessHandler(initialiseSidebar).restoreDefault()
  })


  $('#save-apply').on('click', function () {
    $(this).prop('disabled', true)
    saveProperties()
  })


  $('#cancel').on('click', function () {
    google.script.host.close()
  })

</script>